<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Què és un decorador &mdash; appfusedjango v0.1 documentation</title>
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.1',
        COLLAPSE_MODINDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="appfusedjango v0.1 documentation" href="index.html" />
    <link rel="prev" title="Project" href="project.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="project.html" title="Project"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">appfusedjango v0.1 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="qu-s-un-decorador">
<h1>Què és un decorador<a class="headerlink" href="#qu-s-un-decorador" title="Permalink to this headline">¶</a></h1>
<p>Un decorador és el nom d&#8217;un <em>patró de disseny</em>. Els decoradors alteren de manera dinàmica la funcionalitat d&#8217;una funció,
mètode a classe sense tenir-ne que fer subclasses o canviar el codi font de la classe decorada. En el sentit de Python
un decorador és quelcom més, inclou el patró de disseny, però van més allà, Bruce Eckel els assimila a les macros de Lisp.</p>
<p>Els decoradors i la seva manera d&#8217;utilitzar-se ens ajuden a fer el nostre codi més net, a autodocumentar-lo i a
diferència d&#8217;altres llenguatges de programació no requereixen que ens aprenguem un altre llenguatge de programació
(com passa amb les anotacions de Java per exemple). En la seva utilització podem atracar-nos a la programació orientada
a aspectes (AOP) o utilitzar-los per a afegir sistemes de control a les nostres funcions, de log, caché, ...
Les possibilitats són infinites. El decoradors formen part de Python des de la versió 2.4 i com
diu [Michele Simionato](<a class="reference external" href="http://www.phyast.pitt.edu/~micheles/">http://www.phyast.pitt.edu/~micheles/</a>) ens aporten el següent:</p>
<blockquote>
<ul class="simple">
<li>Redueixen el codi comú i repetitiu (l&#8217;anomenat codi _boilerplate_).</li>
<li>Afavoreixen la separació de responsabilitats del codi</li>
<li>Augmenten la legibilitat i la mantenibilitat</li>
<li>Els decorador són explícits.</li>
</ul>
</blockquote>
<p>Aquesta potència té un preu: en rendiment (que s&#8217;haurà d&#8217;avaluar per a cada aplicació) i en complexitat a l&#8217;hora de
desenvolupar-los. Un decorador típic veurem que és molt bo d&#8217;escriure, però la cosa es complica un poc quan volem passar
paràmetres o mantenir la signatura del mètode. Aquesta complexitat no és tant pel codi que s&#8217;ha d&#8217;escriure sinó perquè
hem de recordar com s&#8217;ha d&#8217;escriure el decorador per a cada cas.</p>
<p>Afortunadament veurem que gent com [Michele Simionato](<a class="reference external" href="http://pypi.python.org/pypi/decorator/3.1.2">http://pypi.python.org/pypi/decorator/3.1.2</a>) han desenvolupat
paquets que ens simplifiquen molt la vida. Tot i això i abans de fer servir aquestes utilitats convé saber què són i
desenvolupar-los sense ajuda. És un poc com aprendre&#8217;s les taules de multiplicar i després ja utilitzar la calculadora.</p>
<div class="section" id="classificaci-dels-decoradors">
<h2>Classificació dels decoradors<a class="headerlink" href="#classificaci-dels-decoradors" title="Permalink to this headline">¶</a></h2>
<p>Podem dividir els decoradors en grups:</p>
<blockquote>
<ul>
<li><dl class="first docutils">
<dt>Segons els paràmetres que admeten:</dt>
<dd><ul class="first last simple">
<li>No admeten paràmetres</li>
<li>Sí admeten paràmetres</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>Segons si preserven la signatura del mètode al que decoren:</dt>
<dd><ul class="first last simple">
<li>Decoradors no que preserven la signatura</li>
<li>Decoradors que si la preserven</li>
</ul>
</dd>
</dl>
</li>
</ul>
</blockquote>
<p>Els decoradors més senzill són aquells que no admeten paràmetres i no preserven la signatura</p>
</div>
<div class="section" id="un-decorador-que-no-fa-res">
<h2>Un decorador que no fa res<a class="headerlink" href="#un-decorador-que-no-fa-res" title="Permalink to this headline">¶</a></h2>
<p>Per començar crearem un decorador que el que farà es convertir qualsevol funció en un /dev/null, és a dir, no retornarà
res i no farà res amb la funció.:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">forat_negre</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">none</span><span class="p">():</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="n">none</span>

<span class="nd">@forat_negre</span>
<span class="k">def</span> <span class="nf">di_hola</span><span class="p">():</span>
    <span class="k">return</span> <span class="s">&quot;hola&quot;</span>
</pre></div>
</div>
<p>Si executam <cite>di_hola()</cite> no tendrem cap resultat, millor dit tindrem <cite>None</cite></p>
<p>La sintaxi &#64; del decorador de Python és el que s&#8217;anomena <strong>syntactic sugar</strong>, és a dir, una manera d&#8217;escriure les coses
que ens simplifica la legibilitat, però fet i fet es podria escriure perfectament com:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">di_hola</span> <span class="o">=</span> <span class="n">forat_negre</span><span class="p">(</span><span class="n">di_hola</span><span class="p">)</span>
<span class="n">di_hola</span><span class="p">()</span>
</pre></div>
</div>
<p>i tendríem el mateix que fa el decorador. Recordem que les funcions són objectes i que es poden assignar i passar com
a paràmetres a Python.</p>
<p>Tot i la senzillesa de l&#8217;exemple ens serveix per veure que un decorador no és més que un envolcall cap a una funció i
per tant ha de retornar una funció, més concretament un <em>callable</em>, per a entendre&#8217;ns, qualsevol cosa que posant-hi
un doble parèntesi al costat () no peti.:</p>
<div class="highlight-python"><pre>def retorna_objecte(f):
   ....:     def obj():
   ....:         return object()
   ....:     return obj
   ....:

In [17]: def di_hola():
   ....:     return "Hola"
   ....:

In [18]: di_hola = retorna_objecte(di_hola)

In [19]: di_hola()
Out[19]: &lt;object object at 0xf7f745e8&gt;</pre>
</div>
<p>Al nostre decorador <cite>forat_negre</cite> li hem passat una funcició sense paràmetres, però si li passam paràmetres ens trobarem
una sorpreseta:</p>
<div class="highlight-python"><pre>#!python
@forat_negre
def suma(a,b):
    return a,b

suma(2,3)

TypeError Traceback (most recent call last)
TypeError: none() takes no arguments (2 given)</pre>
</div>
<p>que per una altra banda és del tot normal, hem definit el <cite>forat_negre</cite> de tal manera que retorna una funció sense
paràmetres, així que si li intentam passar els paràmetres que tenia la funció decorada senzillament es queixa i peta.</p>
<p>Anem a definir un poc millor el nostre decorador per a que no ens passi així i poder admetre el mateixos paràmetres que
la funció decorada:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c">#!python</span>
<span class="k">def</span> <span class="nf">forat_negre</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="s">&quot;d&#39;aquí no surt res&quot;</span>
    <span class="k">def</span> <span class="nf">none</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw_args</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="n">none</span>

<span class="nd">@forat_negre</span>
<span class="k">def</span> <span class="nf">suma</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">):</span>
    <span class="s">&quot;suma dos parametres qualsevols si pot&quot;</span>
    <span class="k">return</span> <span class="n">a</span><span class="o">+</span><span class="n">b</span>

<span class="n">suma</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="mf">2</span><span class="p">)</span>
</pre></div>
</div>
<p>Ara ja no dona error. Així doncs <em>una altra conclusió</em>: a més de tornar una funció, hem de procurar que la definició de
la funció que tornam admeti al manco els mateix nombre de paràmetres que la funció que volem decorar. Si no sabem
quants són aquests ens curam en salut amb *args i **kw_args.</p>
<p>Fixem-nos que no hem mantingut la signatura de la funció i com a experiment intentau fer un help(suma). Tornarem damunt
això un poc més endavant. Ara per ara ja sabem com crear decoradors simples a partir d&#8217;una funció.</p>
</div>
<div class="section" id="fent-decoradors-no-intrusius">
<h2>Fent decoradors no intrusius<a class="headerlink" href="#fent-decoradors-no-intrusius" title="Permalink to this headline">¶</a></h2>
<p>Si heu fet un <cite>help(suma)</cite> o un <cite>suma.__name__</cite> potser un haureu sorprés en veure que le nom de la funció és _none_ en
lloc de l&#8217;esperada <cite>suma</cite>. Si pensau amb el que hem fet tampoc és d&#8217;extranyar, fet i fet hem substituït la funció
original per una altra, recordem que el decorador f aplicat damunt la funció g és equivalent a fer g = f(g).</p>
<p>El que és aconsellable és que el decorador sigui capaç de mantenir la documentació i el nom de la funció que decora,
ja que d&#8217;aquesta manera es simplifica l&#8217;ús de la funció i els autocompletadors de codi no es tornen bojos.</p>
<p>Això ho podem fer de dues maneres: la llarga i la curta</p>
<p><em>La manera llarga</em>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c">#!python</span>
<span class="k">def</span> <span class="nf">forat_negre</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">none</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw_args</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="n">none</span><span class="o">.</span><span class="n">__doc__</span><span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">__doc__</span>
    <span class="n">none</span><span class="o">.</span><span class="n">__dict__</span><span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">__dict__</span>
    <span class="n">none</span><span class="o">.</span><span class="n">__name__</span><span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">__name__</span>
    <span class="k">return</span> <span class="n">none</span>
</pre></div>
</div>
<p>Amb les tres instruccions adicionals que hem posat tornar a recuperar les metadades de la funció original que passam
al decorador. Si hara feim un help veurem que es fa damunt el nom de la funció correcta __suma__ i que l&#8217;ajuda també
és la seva.:</p>
<div class="highlight-python"><pre>Help on function suma in module __main__:

suma(*args, **kw_args)
    Suma dos parametres qualsevols si pot</pre>
</div>
<p>Fixem-nos en la signatura de la funció no s&#8217;ha preservar. Abans admetia dos paràmetres i ara n&#8217;admet un nombre
qualsevol. Per la majoria de casos això no té més importància, però al final de l&#8217;article veurem com es pot resoldre.</p>
<p><em>La manera curta</em></p>
<p>Com que el tema de reservar les metadades és força interessant i comú, al mòdul functools hi trobam la funció <cite>wraps</cite>
que és en sí mateixa un decorador i que fa aquesta funció. D&#8217;aquesta manera el codi anterior quedaria:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c">#!python</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>

<span class="k">def</span> <span class="nf">forat_negre</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">none</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw_args</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="n">none</span>
</pre></div>
</div>
<p>Fixau-vos que hem fet servir un decorador per crear un altre decorador. Insistirem en aquest tema més tard.</p>
</div>
<div class="section" id="un-decorador-amb-arguments">
<h2>Un decorador amb arguments<a class="headerlink" href="#un-decorador-amb-arguments" title="Permalink to this headline">¶</a></h2>
<p>El decorador que hem fet a l&#8217;apartat anterior era prou simple, feia ben poca cosa i no tenia paràmetres. Si volem fer
decoradors hem de fer primer de tot que siguin útils, i també ens trobarem amb la necessitat de que aquests decoradors
admetin paràmetres.</p>
<p>A Django, per exemple, podeu trobar que el [decorador de cache](<a class="reference external" href="http://docs.djangoproject.com/en/dev/topics/cache/">http://docs.djangoproject.com/en/dev/topics/cache/</a>)
admet paràmetres que ens permet dir-li durant quan de temps ha de cachejar els resultats, o el decorador
vary_on_headers, que ens permet modificar el contingut de la resposta de les vistes afegint les capçaleres que indiquem.</p>
<p>Anem a veure com ho podem aconseguir nosaltres. També hi ha dues maneres de fer-ho, la clara i la complexa.
La manera clara és la que recoman i utilitza una classe per a fer el decorador, la complexa requereix més esforça
per a entendre què està fent el decorador, és més curta, però personalment preferesc un codi més legible.</p>
<p>De la mateixa manera els decoradors que hem fet com a funcions es poden crear com a classes, però en aquest cas,
crec que la definició en forma de funcions és més bona de seguir, i ens permetrà distingir clarament entre els dos
tipus de decoradors: el que no admeten paràmetres que es construeixen preferentment mitjançant funcions i els que
admeten paràmetres, que es construeixen preferentment fent servir classes.</p>
<p>Per seguir amb el forat negre, ara el nostre exemple el que farà es mostrar el resultat o no segons li roti.
Per això el que farem serà passar-li una funció com a paràmetre que en ser executada determinarà si s&#8217;ha de mostrar
el resultat de la funció decorada o no</p>
</div>
<div class="section" id="el-m-tode-clar-de-fer-decoradors-amb-arguments">
<h2>El mètode clar de fer decoradors amb arguments<a class="headerlink" href="#el-m-tode-clar-de-fer-decoradors-amb-arguments" title="Permalink to this headline">¶</a></h2>
<p>Anem primer a veure l&#8217;exemple:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c">#!python</span>
<span class="c">#!/usr/bin/env python</span>
<span class="c"># -*- coding: UTF-8 -*-</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="k">class</span> <span class="nc">forat_negre_sonat</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="s">&quot;Un decorador amb fam&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mostrar</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mostrar</span> <span class="o">=</span> <span class="n">mostrar</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">none</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw_args</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mostrar</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw_args</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s">&quot;Nop&quot;</span>
        <span class="k">return</span> <span class="n">none</span>

<span class="nd">@forat_negre_sonat</span><span class="p">(</span><span class="n">mostrar</span> <span class="o">=</span> <span class="k">lambda</span> <span class="p">:</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">((</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">)))</span>
<span class="k">def</span> <span class="nf">suma</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="s">&quot;Suma dos elements que li passam com a paràmetre&quot;</span>
    <span class="k">return</span> <span class="n">a</span><span class="o">+</span><span class="n">b</span>


<span class="k">if</span> <span class="n">__name__</span><span class="o">==</span><span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">suma</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="mf">3</span><span class="p">)</span>
    <span class="k">print</span> <span class="n">suma</span><span class="p">(</span><span class="mf">5</span><span class="p">,</span><span class="mf">6</span><span class="p">)</span>
    <span class="k">print</span> <span class="n">suma</span><span class="p">(</span><span class="mf">9</span><span class="p">,</span><span class="mf">5</span><span class="p">)</span>
</pre></div>
</div>
<p>Fitxem-nos amb que hem fet:</p>
<ol class="arabic simple">
<li>Hem creat una classe Python que al seu constructor (l&#8217;__init__) agafa el paràmetre o paràmetres que vulguem.
És un constructor normal, així que admet paràmetres per defecte per exemple.</li>
<li>Recordem que el decorador hem dit que ha de ser un objecte cridable (callable), a una classe, la cridabilitat
la dóna el mètode __call__. Aquesta classe la  definirem de manera que agafi la funció a decorar com a paràmetre.
D&#8217;aquesta manera tenim accés tant als paràmetres del decorador, que hem passat al constructor, com a la funció
decorada, que hem passat com a paràmetre al call.</li>
</ol>
<p>Després d&#8217;això ja sols en queda encapsular la cridada com ho fèiem al cas anterior, retornant el decorador en lloc
de la funció decorada.</p>
<p>A l&#8217;exemple el que he fet és mostrar que el paràmetre pot ser el que nosaltres vulguem, en concret he passat una
funció anònima, creada amb lambda que és la que s&#8217;encarrega d&#8217;establir l&#8217;aleatoritat del resultat.</p>
<p>Si voleu podem fer aquest decorador una mica més complet, fent que admeti a més de funcions valors i que preservi
el nom i documentació de la funció decorada.:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c">#!/usr/bin/env python</span>
<span class="c"># -*- coding: UTF-8 -*-</span>
<span class="kn">import</span> <span class="nn">random</span>

<span class="k">class</span> <span class="nc">forat_negre_sonat</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="s">&quot;Un decorador amb fam&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mostrar</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mostrar</span> <span class="o">=</span> <span class="n">mostrar</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">none</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw_args</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mostrar</span><span class="p">):</span>
                <span class="n">opcion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mostrar</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">opcion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mostrar</span>
            <span class="k">if</span> <span class="n">opcion</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw_args</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s">&quot;Nop&quot;</span>
        <span class="n">none</span><span class="o">.</span><span class="n">__name__</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">__name__</span>
        <span class="n">none</span><span class="o">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">__doc__</span>
        <span class="k">return</span> <span class="n">none</span>

<span class="nd">@forat_negre_sonat</span><span class="p">(</span><span class="n">mostrar</span> <span class="o">=</span> <span class="k">lambda</span> <span class="p">:</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">((</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">)))</span>
<span class="k">def</span> <span class="nf">suma</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="s">&quot;Suma dos elements que li passam com a paràmetre&quot;</span>
    <span class="k">return</span> <span class="n">a</span><span class="o">+</span><span class="n">b</span>

<span class="nd">@forat_negre_sonat</span><span class="p">(</span><span class="n">mostrar</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">resta</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">a</span><span class="o">-</span><span class="n">b</span>


<span class="k">if</span> <span class="n">__name__</span><span class="o">==</span><span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">&quot;Exemple amb </span><span class="si">%s</span><span class="s"> &quot;</span> <span class="o">%</span> <span class="n">suma</span><span class="o">.</span><span class="n">__name__</span>
    <span class="k">print</span> <span class="n">suma</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="mf">3</span><span class="p">)</span>
    <span class="k">print</span> <span class="n">suma</span><span class="p">(</span><span class="mf">5</span><span class="p">,</span><span class="mf">6</span><span class="p">)</span>
    <span class="k">print</span> <span class="n">suma</span><span class="p">(</span><span class="mf">9</span><span class="p">,</span><span class="mf">5</span><span class="p">)</span>
    <span class="k">print</span> <span class="s">&quot;Exemple amb </span><span class="si">%s</span><span class="s"> &quot;</span> <span class="o">%</span> <span class="n">resta</span><span class="o">.</span><span class="n">__name__</span>
    <span class="k">print</span> <span class="n">resta</span><span class="p">(</span><span class="mf">2</span><span class="p">,</span><span class="mf">3</span><span class="p">)</span>
    <span class="k">print</span> <span class="n">resta</span><span class="p">(</span><span class="mf">5</span><span class="p">,</span><span class="mf">6</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="el-m-tode-enrevessat-de-fer-decoradors-amb-arguments">
<h2>El mètode enrevessat de fer decoradors amb arguments<a class="headerlink" href="#el-m-tode-enrevessat-de-fer-decoradors-amb-arguments" title="Permalink to this headline">¶</a></h2>
<p>El nostre exemple:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">forat_negre_dos</span><span class="p">(</span><span class="n">mostrar</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">wrap</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">wrapped_function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw_args</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">mostrar</span><span class="p">):</span>
                <span class="n">opcion</span> <span class="o">=</span> <span class="n">mostrar</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">opcion</span> <span class="o">=</span> <span class="n">mostrar</span>
            <span class="k">if</span> <span class="n">opcion</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw_args</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s">&quot;Nop&quot;</span>
        <span class="k">return</span> <span class="n">wrapped_function</span>
    <span class="k">return</span> <span class="n">wrap</span>
</pre></div>
</div>
<p>Bé, enrevessat, el que es diu enrevessat no ho és, per una cosa tan simple no té massa història, però fixau-vos que
és un poc més mal de seguir.</p>
<p>El primer que hem fet és definir la nostra funció, on hi hem posat els paràmetres que admet. Aquest funció retorna
una altra funció que admet un argument, que és la funció decorada, que a la seva vegada admet un nombre indeterminat
d&#8217;arguments (recordem que això ho estam forçant nosaltres).</p>
<p>Com que la segona funció, <cite>wrapped_function</cite> està definida dins <cite>wrap</cite>, té accés al paràmetre del decorador i pot
actuar en conseqüència.</p>
</div>
<div class="section" id="encadenant-decoradors">
<h2>Encadenant decoradors<a class="headerlink" href="#encadenant-decoradors" title="Permalink to this headline">¶</a></h2>
<p>Els decoradors es poden encadenar, és a dir, una funció pot tener tans decoradors com faci falta i necessitem,
sols limitats pel nostre sentit comú i la legibilitat del programa. Dos decoradors són habituals, tres no es veuen
gaire, quatre o més són per pensar-s&#8217;ho.</p>
<p>Per a l&#8217;exemple manllevaré un dels decoradors més útils, el memoize, que ens permet cachejar una funció segons
els seus paràmetres. Al Python Decorator Library hi ha una implementació del patró memoize prou senzilla de seguir
amb el que ara sabem i a més ens servirà per completar la construcció de decoradors sense paràmetres fent servir
una classe.:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">memoized</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
   <span class="sd">&quot;&quot;&quot;Decorator that caches a function&#39;s return value each time it is called.</span>
<span class="sd">   If called later with the same arguments, the cached value is returned, and</span>
<span class="sd">   not re-evaluated.</span>
<span class="sd">   &quot;&quot;&quot;</span>
   <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="p">{}</span>
   <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
      <span class="k">try</span><span class="p">:</span>
         <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">args</span><span class="p">]</span>
      <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">args</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
         <span class="k">return</span> <span class="n">value</span>
      <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
         <span class="c"># uncachable -- for instance, passing a list as an argument.</span>
         <span class="c"># Better to not cache than to blow up entirely.</span>
         <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
   <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;Return the function&#39;s docstring.&quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">__doc__</span>
</pre></div>
</div>
<p>A diferència de la construcció amb paràmetres, al constructor de la classe memoized s&#8217;hi posa com a paràmetre
la funció a decorar, i al mètode __call__ hi van els paràmetres de la funció, en lloc de la funció a decorar
com es feia a l&#8217;altre mètode.</p>
<p>Per què s&#8217;ha fet servir aquesta manera si l&#8217;altra és més senzilla? Dons perquè necesitam mantenir en memòria
la caché i el que fa és mantenir-la en un diccionari dins de la mateixa classe. Si la caché fos externa
(amb memcached per exemple),això s&#8217;hauria pogut fer perfectament en forma de funció.</p>
<p>A més definirem un decorador que ens servirar per indicar quan entram a la funció i comprovar el decorador memoized:</p>
<div class="highlight-python"><pre>def log(f):
    "Registra l'execució de la funció"
    def wrap(*args):
        print "Excutant %s, args: %s" % \\
           (f.__name__, ",".join(str(x) for x in args))
        return f(*args)
    return wrap

@memoized
@log
def fibonacci(n):
    "Return the nth fibonacci number."
    if n in (0, 1):
        return n
    return fibonacci(n-1) + fibonacci(n-2)

print fibonacci(12)</pre>
</div>
<p>Provau d&#8217;executar aquest codi amb i sense la funció memoized. Amb els dos decoradors activus veureu que el cada
decorador agafa com a entrada la funció ja decorada que surt del decorador que té més avall. Així el memoized agafa
com a entrada la funció fibonacci ja decorada amb el log.</p>
<p>Podeu fer la prova amb un exemple més simple:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c">#!python</span>
<span class="c">#!/usr/bin/env python</span>
<span class="c"># -*- coding: UTF-8 -*-</span>

<span class="k">def</span> <span class="nf">uppercase</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="s">&quot;Dada una función f que devuelve un string lo pasa todo a mayúsculas&quot;</span>
    <span class="k">def</span> <span class="nf">wrap</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">f</span><span class="p">()</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">wrap</span>

<span class="k">def</span> <span class="nf">make_bold</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="s">&quot;Dada una función f que devuelve un string le añade los tags de bold&quot;</span>
    <span class="k">def</span> <span class="nf">wrap</span><span class="p">():</span>
        <span class="k">return</span> <span class="s">&quot;&lt;strong&gt;</span><span class="si">%s</span><span class="s">&lt;/strong&gt;&quot;</span> <span class="o">%</span> <span class="n">f</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">wrap</span>

<span class="nd">@make_bold</span>
<span class="nd">@uppercase</span>
<span class="k">def</span> <span class="nf">say_hello</span><span class="p">():</span>
    <span class="k">return</span> <span class="s">&quot;Hello world&quot;</span>


<span class="k">print</span> <span class="n">say_hello</span><span class="p">()</span>
</pre></div>
</div>
<p>Provau canviant l&#8217;ordre dels decoradors i veureu perfectament com es van aplicant els decoradors des de la funció per
amunt. A l&#8217;exemple primer es converteix el &#8220;Hello word&#8221; a majúscules i després se li apliquen els tags de negreta.</p>
</div>
<div class="section" id="la-signatura-pendent">
<h2>La signatura pendent<a class="headerlink" href="#la-signatura-pendent" title="Permalink to this headline">¶</a></h2>
<p>Abans d&#8217;acabar ens queda un tema pendent: la signatura. Els decoradors que hem creat poden preservar el nom i la
documentació de la funció que decoren, però no preserven la signatura, és a dir, el nombre de paràmetres que li passam.</p>
<p>Michele Simionato ha escrit un mòdul excel·lent anomenat <em>decorator</em> que extén la utilizació dels decoradors,
mantén la signatura de la funció, el nom i la documentació, i a més ens dona la possibilitat de crear factories de
decoradors. Una eina per a tenir sempre a mà. Amb aquest mòdul podríem escriure el codi de l&#8217;exemple anterior com:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c">#!python</span>
<span class="kn">from</span> <span class="nn">decorator</span> <span class="kn">import</span> <span class="n">decorator</span>

<span class="nd">@decorator</span>
<span class="k">def</span> <span class="nf">uppercase</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="s">&quot;Donada una funció f que retorna un string ho passa a majúscules&quot;</span>
    <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

<span class="nd">@decorator</span>
<span class="k">def</span> <span class="nf">make_bold</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="s">&quot;Afegeix el tag strong a la sortida de la funció&quot;</span>
    <span class="k">return</span> <span class="s">&quot;&lt;strong&gt;</span><span class="si">%s</span><span class="s">&lt;/strong&gt;&quot;</span> <span class="o">%</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

<span class="nd">@uppercase</span>
<span class="nd">@make_bold</span>
<span class="k">def</span> <span class="nf">say_hello</span><span class="p">(</span><span class="n">nom</span><span class="p">):</span>
    <span class="s">&quot;Di hola, home!&quot;</span>
    <span class="k">return</span> <span class="s">&quot;Hello world </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">nom</span>

<span class="k">if</span> <span class="n">__name__</span><span class="o">==</span><span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">inspect</span> <span class="kn">import</span> <span class="n">getargspec</span>
    <span class="k">print</span> <span class="n">say_hello</span><span class="p">(</span><span class="s">&#39;World&#39;</span><span class="p">)</span>
    <span class="k">print</span> <span class="n">say_hello</span><span class="o">.</span><span class="n">func_name</span>
    <span class="k">print</span> <span class="n">say_hello</span><span class="o">.</span><span class="n">__doc__</span>
    <span class="k">print</span> <span class="n">getargspec</span><span class="p">(</span><span class="n">say_hello</span><span class="p">)</span>
</pre></div>
</div>
<p>Si executau el codi podem veure que no ens ha fet falta recore a wraps o a reasignar nom, la pròpia llibreria de
Simionato ho ha fet. A més, si ens fixam en la sortida de l&#8217;exemple:</p>
<div class="highlight-python"><pre>&lt;STRONG&gt;HELLO WORLD WORLD&lt;/STRONG&gt;
say_hello
Di hola, home!
ArgSpec(args=['nom'], varargs=None, keywords=None, defaults=None)</pre>
</div>
<p>La primera línea correspon a la sortida de la funció que hem decorat. La segona és el nom d&#8217;aquesta funció. Ens surt
el nom de la funció original i no el del decorador. La documentació també s&#8217;ha mantingut i per acabar, podem veure
que la signatura de la funció és correcta, ens diu que té un argument obligatori anomenat nom.</p>
</div>
<div class="section" id="conclusi">
<h2>Conclusió<a class="headerlink" href="#conclusi" title="Permalink to this headline">¶</a></h2>
<p>Esper haver deixat un poc més clar el tema dels decoradors. Crear-los no és difícil, utilitzar-los és simple,
sols hem de tenir clar què són i quan fer-los servir. Són una eina potent que ens permet fer el nostre codi més legible
i cohesionat. Fora por i a disfrutar amb els decoradors.</p>
<p>Com tot en aquesta vida, usau-los amb coneixement i moderació.</p>
</div>
<div class="section" id="refer-ncies">
<h2>Referències<a class="headerlink" href="#refer-ncies" title="Permalink to this headline">¶</a></h2>
<p>Per escriure aquest article m&#8217;he basat en múltiples fonts, les més importants i útils han estat:</p>
<ul class="simple">
<li><a class="reference external" href="http://www.python.org/dev/peps/pep-0318">PEP 318</a></li>
<li><a class="reference external" href="http://www.artima.com/weblogs/viewpost.jsp?thread=240808">Decorators I : Introduction to Python Decorators</a></li>
<li>[Decorators II: Decorator Arguments] (<a class="reference external" href="http://www.artima.com/weblogs/viewpost.jsp?thread=240845">http://www.artima.com/weblogs/viewpost.jsp?thread=240845</a>)</li>
<li>[PYthon Decorators] (<a class="reference external" href="http://wiki.python.org/moin/PythonDecorators">http://wiki.python.org/moin/PythonDecorators</a>)</li>
<li>[Understanding decorators](<a class="reference external" href="http://uswaretech.com/blog/2009/06/understanding-decorators/">http://uswaretech.com/blog/2009/06/understanding-decorators/</a> &#8220;The Uswaretech Blog&#8221;)</li>
<li>[Charming Python: Decorators make magic easy] (<a class="reference external" href="http://www.ibm.com/developerworks/linux/library/l-cpdecor.html">http://www.ibm.com/developerworks/linux/library/l-cpdecor.html</a> &#8220;Ibm technical library&#8221;)</li>
<li>[Decorator 3.1.2] (<a class="reference external" href="http://pypi.python.org/pypi/decorator/3.1.2">http://pypi.python.org/pypi/decorator/3.1.2</a> &#8220;Package to simplify decorators&#8221;)</li>
<li>[Decorator Pattern] (<a class="reference external" href="http://en.wikipedia.org/wiki/Decorator_pattern">http://en.wikipedia.org/wiki/Decorator_pattern</a>)</li>
<li>[Python decorator Library](<a class="reference external" href="http://wiki.python.org/moin/PythonDecoratorLibrary">http://wiki.python.org/moin/PythonDecoratorLibrary</a>)</li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <h3><a href="index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference external" href="">Què és un decorador</a><ul>
<li><a class="reference external" href="#classificaci-dels-decoradors">Classificació dels decoradors</a></li>
<li><a class="reference external" href="#un-decorador-que-no-fa-res">Un decorador que no fa res</a></li>
<li><a class="reference external" href="#fent-decoradors-no-intrusius">Fent decoradors no intrusius</a></li>
<li><a class="reference external" href="#un-decorador-amb-arguments">Un decorador amb arguments</a></li>
<li><a class="reference external" href="#el-m-tode-clar-de-fer-decoradors-amb-arguments">El mètode clar de fer decoradors amb arguments</a></li>
<li><a class="reference external" href="#el-m-tode-enrevessat-de-fer-decoradors-amb-arguments">El mètode enrevessat de fer decoradors amb arguments</a></li>
<li><a class="reference external" href="#encadenant-decoradors">Encadenant decoradors</a></li>
<li><a class="reference external" href="#la-signatura-pendent">La signatura pendent</a></li>
<li><a class="reference external" href="#conclusi">Conclusió</a></li>
<li><a class="reference external" href="#refer-ncies">Referències</a></li>
</ul>
</li>
</ul>

            <h4>Previous topic</h4>
            <p class="topless"><a href="project.html"
                                  title="previous chapter">Project</a></p>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="_sources/decoradors.txt"
                     rel="nofollow">Show Source</a></li>
            </ul>
          <div id="searchbox" style="display: none">
            <h3>Quick search</h3>
              <form class="search" action="search.html" method="get">
                <input type="text" name="q" size="18" />
                <input type="submit" value="Go" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="project.html" title="Project"
             >previous</a> |</li>
        <li><a href="index.html">appfusedjango v0.1 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
      &copy; Copyright 2009, antoni aloy.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 0.6.3.
    </div>
  </body>
</html>